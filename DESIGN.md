# Level-IP è¯¦ç»†è®¾è®¡æ–‡æ¡£

## ğŸ“š æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£é¢å‘åˆå­¦è€…ï¼Œè¯¦ç»†è®²è§£ Level-IP ç”¨æˆ·æ€ TCP/IP åè®®æ ˆçš„è®¾è®¡ä¸å®ç°ã€‚åŒ…å«å®Œæ•´çš„æ¶æ„è¯´æ˜ã€æ•°æ®æµç¨‹å›¾ã€æ—¶åºå›¾å’Œä»£ç ç»†èŠ‚ã€‚

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 ä»€ä¹ˆæ˜¯ Level-IPï¼Ÿ

Level-IP æ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ **Linux ç”¨æˆ·ç©ºé—´** çš„ TCP/IP åè®®æ ˆå®ç°ã€‚å®ƒä¸æ˜¯å†…æ ¸æ¨¡å—ï¼Œè€Œæ˜¯ä¸€ä¸ªæ™®é€šçš„ç”¨æˆ·ç¨‹åºï¼Œé€šè¿‡ **TUN/TAP è™šæ‹Ÿç½‘å¡** ä¸æ“ä½œç³»ç»Ÿäº¤äº’ã€‚

**å…³é”®æ¦‚å¿µï¼š**
- **ç”¨æˆ·ç©ºé—´ï¼ˆUserspaceï¼‰**ï¼šæ™®é€šåº”ç”¨ç¨‹åºè¿è¡Œçš„ç©ºé—´ï¼Œä¸éœ€è¦ç‰¹æ®Šæƒé™
- **å†…æ ¸ç©ºé—´ï¼ˆKernel Spaceï¼‰**ï¼šæ“ä½œç³»ç»Ÿæ ¸å¿ƒä»£ç è¿è¡Œçš„ç©ºé—´
- **TUN/TAP è®¾å¤‡**ï¼šLinux æä¾›çš„è™šæ‹Ÿç½‘å¡ï¼Œå¯ä»¥è®©ç”¨æˆ·ç¨‹åºç›´æ¥æ”¶å‘ç½‘ç»œæ•°æ®åŒ…

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

è¿™æ˜¯ä¸€ä¸ª **æ•™è‚²é¡¹ç›®**ï¼Œç›®çš„æ˜¯ï¼š
1. å­¦ä¹  TCP/IP åè®®æ ˆçš„å·¥ä½œåŸç†
2. ç†è§£ Linux ç½‘ç»œç¼–ç¨‹
3. æŒæ¡ Socket API çš„å†…éƒ¨å®ç°

**âš ï¸ é‡è¦æç¤º**ï¼šè¿™ä¸æ˜¯ç”Ÿäº§ç¯å¢ƒä»£ç ï¼å®ƒæœ‰å¾ˆå¤šç®€åŒ–å’Œç¡¬ç¼–ç çš„åœ°æ–¹ã€‚

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº”ç”¨ç¨‹åºå±‚                              â”‚
â”‚          (curl, firefox ç­‰åº”ç”¨ç¨‹åº)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ é€šè¿‡ liblevelip.so æ‹¦æˆª socket API è°ƒç”¨
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              liblevelip.so (åŠ¨æ€åº“)                       â”‚
â”‚     æ‹¦æˆª: socket(), connect(), read(), write()...         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ Unix Domain Socket (IPC é€šä¿¡)
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  lvl-ip å®ˆæŠ¤è¿›ç¨‹                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  çº¿ç¨‹ 1: THREAD_CORE (ç½‘ç»œæ•°æ®åŒ…å¤„ç†)             â”‚    â”‚
â”‚  â”‚  çº¿ç¨‹ 2: THREAD_TIMERS (TCP å®šæ—¶å™¨)              â”‚    â”‚
â”‚  â”‚  çº¿ç¨‹ 3: THREAD_IPC (å¤„ç†åº”ç”¨ç¨‹åºè¯·æ±‚)            â”‚    â”‚
â”‚  â”‚  çº¿ç¨‹ 4: THREAD_SIGNAL (ä¿¡å·å¤„ç†)                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          åè®®æ ˆå„å±‚                               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Socket API å±‚ (socket.c, sock.c)         â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                 â”‚                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  TCP å±‚ (tcp.c, tcp_input.c, tcp_output.c)â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                 â”‚                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  IP å±‚ (ip_input.c, ip_output.c, route.c) â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                 â”‚                                 â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  é“¾è·¯å±‚ (arp.c, ethernet.h, netdev.c)     â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   TAP è™šæ‹Ÿç½‘å¡ (tap0)   â”‚
        â”‚   IP: 10.0.0.5/24      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Linux å†…æ ¸ç½‘ç»œæ ˆ      â”‚
        â”‚   (NAT + è½¬å‘)         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
              ã€çœŸå®ç½‘ç»œ / äº’è”ç½‘ã€‘
```

### 2.2 å››ä¸ªæ ¸å¿ƒçº¿ç¨‹

Level-IP å¯åŠ¨åä¼šåˆ›å»º 4 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£ä¸åŒçš„ä»»åŠ¡ï¼š

**ä»£ç ä½ç½®ï¼š** [src/main.c:19-23](src/main.c#L19-L23)

```c
#define THREAD_CORE 0      // ç½‘ç»œæ•°æ®åŒ…æ¥æ”¶çº¿ç¨‹
#define THREAD_TIMERS 1    // TCP å®šæ—¶å™¨çº¿ç¨‹
#define THREAD_IPC 2       // IPC é€šä¿¡çº¿ç¨‹
#define THREAD_SIGNAL 3    // ä¿¡å·å¤„ç†çº¿ç¨‹
static pthread_t threads[4];
```

#### çº¿ç¨‹ 1: THREAD_CORE - æ•°æ®åŒ…æ¥æ”¶

**ä»£ç ä½ç½®ï¼š** [src/netdev.c:86-101](src/netdev.c#L86-L101)

```c
void *netdev_rx_loop()
{
    while (running) {
        struct sk_buff *skb = alloc_skb(BUFLEN);

        if (tun_read((char *)skb->data, BUFLEN) < 0) {
            perror("ERR: Read from tun_fd");
            free_skb(skb);
            return NULL;
        }

        netdev_receive(skb);
    }

    return NULL;
}
```

**åŠŸèƒ½ï¼š**
- æ— é™å¾ªç¯ä» TAP è®¾å¤‡è¯»å–æ•°æ®åŒ…
- å°†è¯»åˆ°çš„æ•°æ®å°è£…æˆ `sk_buff` ç»“æ„
- è°ƒç”¨ `netdev_receive()` å¤„ç†æ•°æ®åŒ…

#### çº¿ç¨‹ 2: THREAD_TIMERS - TCP å®šæ—¶å™¨

**ä»£ç ä½ç½®ï¼š** [src/timer.c](src/timer.c)

**åŠŸèƒ½ï¼š**
- ç®¡ç† TCP é‡ä¼ å®šæ—¶å™¨
- ç®¡ç† TCP è¶…æ—¶å®šæ—¶å™¨
- å®šæœŸæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ‰§è¡Œçš„å®šæ—¶ä»»åŠ¡

#### çº¿ç¨‹ 3: THREAD_IPC - åº”ç”¨ç¨‹åºé€šä¿¡

**ä»£ç ä½ç½®ï¼š** [src/ipc.c](src/ipc.c)

**åŠŸèƒ½ï¼š**
- ç›‘å¬ Unix Domain Socket
- æ¥æ”¶åº”ç”¨ç¨‹åºçš„ socket API è°ƒç”¨è¯·æ±‚
- å°†è¯·æ±‚è½¬å‘ç»™å¯¹åº”çš„åè®®æ ˆå¤„ç†å‡½æ•°
- è¿”å›ç»“æœç»™åº”ç”¨ç¨‹åº

#### çº¿ç¨‹ 4: THREAD_SIGNAL - ä¿¡å·å¤„ç†

**ä»£ç ä½ç½®ï¼š** [src/main.c:36-58](src/main.c#L36-L58)

```c
static void *stop_stack_handler(void *arg)
{
    int err, signo;

    for (;;) {
        err = sigwait(&mask, &signo);
        if (err != 0) {
            print_err("Sigwait failed: %d\n", err);
        }

        switch (signo) {
        case SIGINT:
        case SIGQUIT:
            running = 0;
            pthread_cancel(threads[THREAD_IPC]);
            pthread_cancel(threads[THREAD_CORE]);
            pthread_cancel(threads[THREAD_TIMERS]);
            return 0;
        default:
            printf("Unexpected signal %d\n", signo);
        }
    }
}
```

**åŠŸèƒ½ï¼š**
- ç­‰å¾… SIGINTï¼ˆCtrl+Cï¼‰æˆ– SIGQUIT ä¿¡å·
- æ”¶åˆ°ä¿¡å·åä¼˜é›…åœ°å…³é—­æ‰€æœ‰çº¿ç¨‹
- æ¸…ç†èµ„æº

---

## 3. æ ¸å¿ƒæ•°æ®ç»“æ„

### 3.1 sk_buff - æ•°æ®åŒ…ç¼“å†²åŒº

**ä»£ç ä½ç½®ï¼š** [include/skbuff.h](include/skbuff.h)

```c
struct sk_buff {
    struct list_head list;      // é“¾è¡¨èŠ‚ç‚¹ï¼ˆç”¨äºå°†å¤šä¸ª skb é“¾æ¥æˆé˜Ÿåˆ—ï¼‰
    int refcnt;                 // å¼•ç”¨è®¡æ•°
    struct sock *sk;            // æ‰€å±çš„ socket
    uint32_t len;               // æ•°æ®é•¿åº¦
    uint32_t dlen;              // çœŸå®æ•°æ®é•¿åº¦ï¼ˆä¸åŒ…æ‹¬ TCP å¤´ï¼‰
    uint32_t seq;               // TCP åºåˆ—å·
    uint32_t end_seq;           // ç»“æŸåºåˆ—å·
    uint8_t *data;              // æ•°æ®æŒ‡é’ˆ
    uint8_t *head;              // ç¼“å†²åŒºå¤´éƒ¨
    uint8_t *end;               // ç¼“å†²åŒºå°¾éƒ¨
    uint8_t *payload;           // æœ‰æ•ˆè½½è·æŒ‡é’ˆ
    struct netdev *dev;         // ç½‘å¡è®¾å¤‡
    uint16_t protocol;          // åè®®ç±»å‹
};
```

**ç±»æ¯”ç†è§£ï¼š**
- å¯ä»¥æŠŠ `sk_buff` æƒ³è±¡æˆä¸€ä¸ª"ä¿¡å°"
- `data` æŒ‡å‘ä¿¡å°çš„å½“å‰å†…å®¹
- `head` å’Œ `end` æ ‡è®°ä¿¡å°çš„æ•´ä¸ªç©ºé—´
- `payload` æŒ‡å‘çœŸæ­£çš„æ•°æ®å†…å®¹ï¼ˆå»æ‰å„å±‚åè®®å¤´åï¼‰

**å…³é”®æ“ä½œï¼š**

```c
// 1. åˆ†é… sk_buff
struct sk_buff *skb = alloc_skb(BUFLEN);

// 2. åœ¨æ•°æ®å‰é¢æ·»åŠ åè®®å¤´ï¼ˆæ¯”å¦‚ TCP å¤´ï¼‰
skb_push(skb, TCP_HDR_LEN);

// 3. å»æ‰åè®®å¤´
skb_pull(skb, TCP_HDR_LEN);

// 4. é¢„ç•™ç©ºé—´
skb_reserve(skb, ETH_HDR_LEN);
```

### 3.2 socket å’Œ sock - å¥—æ¥å­—ç»“æ„

Level-IP ä½¿ç”¨ä¸¤å±‚ç»“æ„æ¥è¡¨ç¤ºå¥—æ¥å­—ï¼š

#### å¤–å±‚ï¼šstruct socket

**ä»£ç ä½ç½®ï¼š** [include/socket.h:59-71](include/socket.h#L59-L71)

```c
struct socket {
    struct list_head list;      // å…¨å±€ socket é“¾è¡¨èŠ‚ç‚¹
    int fd;                     // æ–‡ä»¶æè¿°ç¬¦
    pid_t pid;                  // æ‰€å±è¿›ç¨‹ ID
    int refcnt;                 // å¼•ç”¨è®¡æ•°
    enum socket_state state;    // Socket çŠ¶æ€ (SS_FREE, SS_CONNECTED...)
    struct sock *sk;            // æŒ‡å‘å†…å±‚ sock ç»“æ„
    struct sock_ops *ops;       // Socket æ“ä½œå‡½æ•°
    short type;                 // Socket ç±»å‹ (SOCK_STREAM...)
    int flags;                  // æ ‡å¿—ä½
    struct wait_lock sleep;     // ç­‰å¾…é˜Ÿåˆ—ï¼ˆé˜»å¡æ“ä½œç”¨ï¼‰
    pthread_rwlock_t lock;      // è¯»å†™é”
};
```

#### å†…å±‚ï¼šstruct sock

**ä»£ç ä½ç½®ï¼š** [include/sock.h](include/sock.h)

```c
struct sock {
    struct socket *sock;        // æŒ‡å›å¤–å±‚ socket
    uint8_t protocol;           // åè®®ç±»å‹ (IPPROTO_TCP)
    uint16_t sport;             // æºç«¯å£
    uint16_t dport;             // ç›®æ ‡ç«¯å£
    uint32_t saddr;             // æº IP åœ°å€
    uint32_t daddr;             // ç›®æ ‡ IP åœ°å€
    int state;                  // TCP çŠ¶æ€ (TCP_LISTEN, TCP_ESTABLISHED...)

    struct sk_buff_head receive_queue;  // æ¥æ”¶é˜Ÿåˆ—
    struct sk_buff_head write_queue;    // å‘é€é˜Ÿåˆ—

    int err;                    // é”™è¯¯ç 
    int poll_events;            // poll äº‹ä»¶
    struct net_ops *ops;        // åè®®æ“ä½œå‡½æ•°
};
```

#### TCP ä¸“ç”¨ï¼šstruct tcp_sock

**ä»£ç ä½ç½®ï¼š** [include/tcp.h](include/tcp.h)

```c
struct tcp_sock {
    struct sock sk;             // ç»§æ‰¿è‡ª sock

    // TCP æ§åˆ¶å— (TCB)
    struct {
        uint32_t snd_una;       // å‘é€æ–¹ï¼šæœ€è€çš„æœªç¡®è®¤åºåˆ—å·
        uint32_t snd_nxt;       // å‘é€æ–¹ï¼šä¸‹ä¸€ä¸ªè¦å‘é€çš„åºåˆ—å·
        uint32_t snd_wnd;       // å‘é€æ–¹ï¼šå‘é€çª—å£å¤§å°
        uint32_t snd_wl1;       // å‘é€æ–¹ï¼šç”¨äºçª—å£æ›´æ–°çš„åºåˆ—å·
        uint32_t snd_wl2;       // å‘é€æ–¹ï¼šç”¨äºçª—å£æ›´æ–°çš„ç¡®è®¤å·
        uint32_t rcv_nxt;       // æ¥æ”¶æ–¹ï¼šä¸‹ä¸€ä¸ªæœŸæœ›çš„åºåˆ—å·
        uint32_t rcv_wnd;       // æ¥æ”¶æ–¹ï¼šæ¥æ”¶çª—å£å¤§å°
        uint32_t iss;           // åˆå§‹å‘é€åºåˆ—å·
        uint32_t irs;           // åˆå§‹æ¥æ”¶åºåˆ—å·
    } tcb;

    uint16_t rmss;              // æ¥æ”¶æœ€å¤§æ®µå¤§å°
    uint16_t smss;              // å‘é€æœ€å¤§æ®µå¤§å°

    int rto;                    // é‡ä¼ è¶…æ—¶æ—¶é—´
    int backoff;                // é€€é¿ç³»æ•°

    struct sk_buff_head ofo_queue;  // ä¹±åºé˜Ÿåˆ—
    // ... æ›´å¤šå­—æ®µ
};
```

### 3.3 é“¾è¡¨ - æ•°æ®ç»“æ„çš„æ ¸å¿ƒ

Level-IP ä½¿ç”¨ Linux å†…æ ¸é£æ ¼çš„ **ä¾µå…¥å¼é“¾è¡¨**ã€‚

**ä»£ç ä½ç½®ï¼š** [include/list.h](include/list.h)

```c
struct list_head {
    struct list_head *next;
    struct list_head *prev;
};

// åˆå§‹åŒ–é“¾è¡¨å¤´
#define LIST_HEAD(name) \
    struct list_head name = { &(name), &(name) }

// åœ¨é“¾è¡¨å°¾éƒ¨æ·»åŠ å…ƒç´ 
void list_add_tail(struct list_head *new, struct list_head *head);

// éå†é“¾è¡¨
#define list_for_each(pos, head) \
    for (pos = (head)->next; pos != (head); pos = pos->next)

// ä»é“¾è¡¨èŠ‚ç‚¹è·å–åŒ…å«å®ƒçš„ç»“æ„ä½“
#define list_entry(ptr, type, member) \
    ((type *)((char *)(ptr) - offsetof(type, member)))
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```c
// å®šä¹‰ä¸€ä¸ªåŒ…å«é“¾è¡¨èŠ‚ç‚¹çš„ç»“æ„ä½“
struct my_data {
    int value;
    struct list_head list;  // é“¾è¡¨èŠ‚ç‚¹
};

// åˆ›å»ºé“¾è¡¨å¤´
LIST_HEAD(my_list);

// æ·»åŠ å…ƒç´ 
struct my_data *data = malloc(sizeof(struct my_data));
data->value = 42;
list_init(&data->list);
list_add_tail(&data->list, &my_list);

// éå†é“¾è¡¨
struct list_head *item;
struct my_data *entry;
list_for_each(item, &my_list) {
    entry = list_entry(item, struct my_data, list);
    printf("value = %d\n", entry->value);
}
```

---

## 4. æ•°æ®åŒ…æ¥æ”¶æµç¨‹ï¼ˆè‡ªåº•å‘ä¸Šï¼‰

### 4.1 å®Œæ•´æµç¨‹å›¾

```
                      ã€ç½‘ç»œæ•°æ®åŒ…åˆ°è¾¾ã€‘
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  1. TAP è®¾å¤‡æ¥æ”¶ (tuntap_if.c)       â”‚
        â”‚     tun_read()                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ è¯»å–ä»¥å¤ªç½‘å¸§
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  2. ç½‘ç»œè®¾å¤‡å±‚ (netdev.c)             â”‚
        â”‚     netdev_rx_loop()                 â”‚
        â”‚     â†’ netdev_receive()               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ è§£æä»¥å¤ªç½‘ç±»å‹
                       â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
               â”‚               â”‚
       EtherType=0x0806   EtherType=0x0800
         (ARP)              (IPv4)
               â”‚               â”‚
               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  3a. ARP å¤„ç†    â”‚  â”‚  3b. IP å¤„ç†     â”‚
    â”‚  arp_rcv()      â”‚  â”‚  ip_rcv()       â”‚
    â”‚  (arp.c:74)     â”‚  â”‚  (ip_input.c)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ è§£æ IP åè®®å·
                                  â–¼
                         Protocol = 6 (TCP)
                                  â”‚
                                  â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  4. TCP è¾“å…¥å¤„ç†          â”‚
                    â”‚     tcp_in()             â”‚
                    â”‚     (tcp.c:57)           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ æŸ¥æ‰¾å¯¹åº”çš„ socket
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  inet_lookup()           â”‚
                    â”‚  æ ¹æ®ç«¯å£å·æŸ¥æ‰¾ socket    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ æ‰¾åˆ° socket
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  5. TCP çŠ¶æ€æœºå¤„ç†        â”‚
                    â”‚     tcp_input_state()    â”‚
                    â”‚     (tcp_input.c)        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ æ ¹æ®å½“å‰çŠ¶æ€å¤„ç†
                               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                    â”‚                    â”‚
    â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼   â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼   â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼
  TCP_LISTEN    TCP_SYN_SENT      TCP_ESTABLISHED
  TCP_SYN_RCVD  TCP_FIN_WAIT_1    TCP_CLOSE_WAIT
       â”‚               â”‚                    â”‚
       â”‚               â”‚                    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ å¤„ç†å®Œæˆ
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  6. æ•°æ®æ”¾å…¥æ¥æ”¶é˜Ÿåˆ—  â”‚
            â”‚     sk->receive_queueâ”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ å”¤é†’ç­‰å¾…çš„åº”ç”¨ç¨‹åº
                       â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  7. é€šçŸ¥åº”ç”¨ç¨‹åº      â”‚
            â”‚     wait_wakeup()   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 è¯¦ç»†æ­¥éª¤è¯´æ˜

#### æ­¥éª¤ 1: TAP è®¾å¤‡è¯»å–

**ä»£ç ä½ç½®ï¼š** [src/tuntap_if.c:63-66](src/tuntap_if.c#L63-L66)

```c
int tun_read(char *buf, int len)
{
    return read(tun_fd, buf, len);
}
```

**è¿‡ç¨‹ï¼š**
1. `THREAD_CORE` çº¿ç¨‹è°ƒç”¨ `tun_read()` ä» TAP è®¾å¤‡è¯»å–æ•°æ®
2. è¿™æ˜¯ä¸€ä¸ª**é˜»å¡è°ƒç”¨**ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®ä¼šä¸€ç›´ç­‰å¾…
3. è¯»åˆ°çš„æ•°æ®æ˜¯**å®Œæ•´çš„ä»¥å¤ªç½‘å¸§**ï¼ˆåŒ…å«ä»¥å¤ªç½‘å¤´ï¼‰

#### æ­¥éª¤ 2: ä»¥å¤ªç½‘å¸§è§£æ

**ä»£ç ä½ç½®ï¼š** [src/netdev.c:63-84](src/netdev.c#L63-L84)

```c
static int netdev_receive(struct sk_buff *skb)
{
    struct eth_hdr *hdr = eth_hdr(skb);

    eth_dbg("in", hdr);

    switch (hdr->ethertype) {
        case ETH_P_ARP:
            arp_rcv(skb);
            break;
        case ETH_P_IP:
            ip_rcv(skb);
            break;
        case ETH_P_IPV6:
        default:
            printf("Unsupported ethertype %x\n", hdr->ethertype);
            free_skb(skb);
            break;
    }

    return 0;
}
```

**ä»¥å¤ªç½‘å¸§ç»“æ„ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç›®æ ‡ MAC (6 å­—èŠ‚)  â”‚  æº MAC (6 å­—èŠ‚)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç±»å‹ (2 å­—èŠ‚)      â”‚  æ•°æ® (46-1500 å­—èŠ‚)      â”‚
â”‚  0x0800 = IPv4      â”‚                           â”‚
â”‚  0x0806 = ARP       â”‚                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ­¥éª¤ 3: IP å±‚å¤„ç†

**ä»£ç ä½ç½®ï¼š** [src/ip_input.c](src/ip_input.c)

å…³é”®åŠŸèƒ½ï¼š
1. éªŒè¯ IP æ ¡éªŒå’Œ
2. æ£€æŸ¥ IP åœ°å€æ˜¯å¦æ˜¯å‘ç»™æœ¬æœºçš„
3. æ ¹æ®åè®®å·åˆ†å‘åˆ°ä¸Šå±‚ï¼ˆTCPã€UDPã€ICMPï¼‰

#### æ­¥éª¤ 4: TCP å±‚å¤„ç†

**ä»£ç ä½ç½®ï¼š** [src/tcp.c:57-85](src/tcp.c#L57-L85)

```c
void tcp_in(struct sk_buff *skb)
{
    struct sock *sk;
    struct iphdr *iph;
    struct tcphdr *th;

    iph = ip_hdr(skb);
    th = (struct tcphdr*) iph->data;

    tcp_init_segment(th, iph, skb);  // åˆå§‹åŒ– TCP æ®µä¿¡æ¯

    sk = inet_lookup(skb, th->sport, th->dport);  // æŸ¥æ‰¾ socket

    if (sk == NULL) {
        print_err("No TCP socket for sport %d dport %d\n",
                  th->sport, th->dport);
        free_skb(skb);
        return;
    }
    socket_wr_acquire(sk->sock);  // è·å– socket é”

    tcp_in_dbg(th, sk, skb);
    tcp_input_state(sk, th, skb);  // çŠ¶æ€æœºå¤„ç†

    socket_release(sk->sock);  // é‡Šæ”¾é”
}
```

**TCP å¤´éƒ¨ç»“æ„ï¼š**

```
 0                   1                   2                   3
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          æºç«¯å£               |          ç›®æ ‡ç«¯å£              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        åºåˆ—å· (Sequence Number)               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    ç¡®è®¤å· (Acknowledgment Number)             |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  å¤´é•¿ |ä¿ç•™| |U|A|P|R|S|F|                                    |
|       |    | |R|C|S|S|Y|I|            çª—å£å¤§å°                |
|       |    | |G|K|H|T|N|N|                                    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           æ ¡éªŒå’Œ              |         ç´§æ€¥æŒ‡é’ˆ               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    é€‰é¡¹ (å¯é€‰)                    |  å¡«å……      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             æ•°æ®                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

---

## 5. æ•°æ®åŒ…å‘é€æµç¨‹ï¼ˆè‡ªé¡¶å‘ä¸‹ï¼‰

### 5.1 å®Œæ•´æµç¨‹å›¾

```
                ã€åº”ç”¨ç¨‹åºè°ƒç”¨ write()ã€‘
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  1. liblevelip.so æ‹¦æˆªè°ƒç”¨           â”‚
        â”‚     write() â†’ lvlip_write()         â”‚
        â”‚     (tools/liblevelip.c)            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ é€šè¿‡ Unix Socket å‘é€ IPC æ¶ˆæ¯
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  2. IPC çº¿ç¨‹æ¥æ”¶è¯·æ±‚                 â”‚
        â”‚     THREAD_IPC                      â”‚
        â”‚     ipc_write() (src/ipc.c)         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ è°ƒç”¨ socket çš„ write æ“ä½œ
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  3. Socket å±‚å¤„ç†                    â”‚
        â”‚     _socket_write()                 â”‚
        â”‚     â†’ sock->ops->write()            â”‚
        â”‚     (src/socket.c)                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ è°ƒç”¨ TCP å†™å‡½æ•°
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  4. TCP å±‚å¤„ç†                       â”‚
        â”‚     tcp_write()                     â”‚
        â”‚     (src/tcp.c)                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ å°†æ•°æ®æ”¾å…¥å‘é€é˜Ÿåˆ—
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5. TCP è¾“å‡ºå¤„ç†                     â”‚
        â”‚     tcp_output()                    â”‚
        â”‚     (src/tcp_output.c)              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ æ„é€  TCP æ®µ
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  6. IP å±‚å¤„ç†                        â”‚
        â”‚     ip_output()                     â”‚
        â”‚     (src/ip_output.c)               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ æ·»åŠ  IP å¤´
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  7. é“¾è·¯å±‚å¤„ç†                       â”‚
        â”‚     netdev_transmit()               â”‚
        â”‚     (src/netdev.c)                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ æ·»åŠ ä»¥å¤ªç½‘å¤´
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  8. TAP è®¾å¤‡å†™å…¥                     â”‚
        â”‚     tun_write()                     â”‚
        â”‚     (src/tuntap_if.c)               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
                 ã€æ•°æ®åŒ…å‘é€åˆ°ç½‘ç»œã€‘
```

### 5.2 è¯¦ç»†æ­¥éª¤è¯´æ˜

#### æ­¥éª¤ 1-2: åº”ç”¨ç¨‹åºåˆ° IPC

å½“åº”ç”¨ç¨‹åºè°ƒç”¨ `write(fd, buf, len)` æ—¶ï¼š

1. **åŠ¨æ€é“¾æ¥å™¨** ä¼šå…ˆæŸ¥æ‰¾ `liblevelip.so` ä¸­çš„ `write()` å‡½æ•°
2. `liblevelip.so` æ£€æŸ¥ `fd` æ˜¯å¦æ˜¯ Level-IP ç®¡ç†çš„ socket
3. å¦‚æœæ˜¯ï¼Œåˆ™é€šè¿‡ **Unix Domain Socket** å‘é€ IPC æ¶ˆæ¯ç»™ lvl-ip å®ˆæŠ¤è¿›ç¨‹
4. æ¶ˆæ¯æ ¼å¼ï¼š`[æ¶ˆæ¯ç±»å‹ | PID | FD | æ•°æ®é•¿åº¦ | æ•°æ®å†…å®¹]`

**ä»£ç ä½ç½®ï¼š** [tools/liblevelip.c](tools/liblevelip.c)

#### æ­¥éª¤ 4: TCP å†™å…¥

**ä»£ç ä½ç½®ï¼š** [src/tcp.c](src/tcp.c) ä¸­çš„ `tcp_write()` å‡½æ•°

```c
int tcp_write(struct sock *sk, const void *buf, int len)
{
    struct tcp_sock *tsk = tcp_sk(sk);
    int mss = tsk->smss;  // æœ€å¤§æ®µå¤§å°

    // åˆ†æ®µå‘é€æ•°æ®
    while (len > 0) {
        int slen = min(len, mss);  // æ¯æ¬¡æœ€å¤šå‘é€ MSS å­—èŠ‚

        struct sk_buff *skb = alloc_skb(slen);
        memcpy(skb->data, buf, slen);

        skb_queue_tail(&sk->write_queue, skb);  // åŠ å…¥å‘é€é˜Ÿåˆ—

        buf += slen;
        len -= slen;
    }

    tcp_output(sk);  // è§¦å‘å®é™…å‘é€
}
```

#### æ­¥éª¤ 5: TCP è¾“å‡º

**ä»£ç ä½ç½®ï¼š** [src/tcp_output.c](src/tcp_output.c)

å…³é”®æ“ä½œï¼š
1. ä»å‘é€é˜Ÿåˆ—å–å‡ºæ•°æ®
2. æ„é€  TCP å¤´éƒ¨
3. è®¾ç½®åºåˆ—å·ã€ç¡®è®¤å·ã€çª—å£å¤§å°
4. è®¡ç®—æ ¡éªŒå’Œ
5. è°ƒç”¨ IP å±‚å‘é€

---

## 6. TCP ä¸‰æ¬¡æ¡æ‰‹è¯¦è§£

### 6.1 æ—¶åºå›¾

```
åº”ç”¨ç¨‹åº              liblevelip          lvl-ipå®ˆæŠ¤è¿›ç¨‹         è¿œç¨‹æœåŠ¡å™¨
   â”‚                     â”‚                      â”‚                    â”‚
   â”‚ connect()           â”‚                      â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                    â”‚
   â”‚                     â”‚  IPC: CONNECT        â”‚                    â”‚
   â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
   â”‚                     â”‚                      â”‚                    â”‚
   â”‚                     â”‚                 ã€æ­¥éª¤1ï¼šå‘é€ SYNã€‘        â”‚
   â”‚                     â”‚                      â”‚                    â”‚
   â”‚                     â”‚                      â”‚  SYN, seq=1000     â”‚
   â”‚                     â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                     â”‚                      â”‚ (çŠ¶æ€: SYN_SENT)   â”‚
   â”‚                     â”‚                      â”‚                    â”‚
   â”‚                     â”‚                 ã€æ­¥éª¤2ï¼šæ¥æ”¶ SYN+ACKã€‘    â”‚
   â”‚                     â”‚                      â”‚                    â”‚
   â”‚                     â”‚                      â”‚ SYN+ACK, seq=2000  â”‚
   â”‚                     â”‚                      â”‚ ack=1001           â”‚
   â”‚                     â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                     â”‚                      â”‚(çŠ¶æ€:ESTABLISHED)  â”‚
   â”‚                     â”‚                      â”‚                    â”‚
   â”‚                     â”‚                 ã€æ­¥éª¤3ï¼šå‘é€ ACKã€‘        â”‚
   â”‚                     â”‚                      â”‚                    â”‚
   â”‚                     â”‚                      â”‚  ACK, seq=1001     â”‚
   â”‚                     â”‚                      â”‚  ack=2001          â”‚
   â”‚                     â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                     â”‚                      â”‚                    â”‚
   â”‚                     â”‚  IPC: è¿”å›æˆåŠŸ        â”‚                    â”‚
   â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚
   â”‚ connect() è¿”å› 0     â”‚                      â”‚                    â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                    â”‚
   â”‚                     â”‚                      â”‚                    â”‚
```

### 6.2 ä»£ç å®ç°è¯¦è§£

#### æ­¥éª¤ 1: å®¢æˆ·ç«¯å‘é€ SYN

**ä»£ç ä½ç½®ï¼š** [src/tcp.c](src/tcp.c) ä¸­çš„ `tcp_v4_connect()`

```c
int tcp_v4_connect(struct sock *sk, const struct sockaddr *addr, int addrlen, int flags)
{
    struct tcp_sock *tsk = tcp_sk(sk);
    uint16_t dport = ((struct sockaddr_in *)addr)->sin_port;
    uint32_t daddr = ((struct sockaddr_in *)addr)->sin_addr.s_addr;

    // 1. ç”Ÿæˆæœ¬åœ°ç«¯å£
    sk->sport = generate_port();

    // 2. è®¾ç½®ç›®æ ‡åœ°å€å’Œç«¯å£
    sk->daddr = ntohl(daddr);
    sk->dport = ntohs(dport);

    // 3. ç”Ÿæˆåˆå§‹åºåˆ—å· (ISS)
    tsk->tcb.iss = generate_iss();
    tsk->tcb.snd_una = tsk->tcb.iss;
    tsk->tcb.snd_nxt = tsk->tcb.iss;

    // 4. è®¾ç½®çŠ¶æ€ä¸º SYN_SENT
    tcp_set_state(sk, TCP_SYN_SENT);

    // 5. å‘é€ SYN åŒ…
    tcp_send_synack(sk);

    // 6. ç­‰å¾…è¿æ¥å»ºç«‹
    if (flags & O_NONBLOCK) {
        return -EINPROGRESS;
    } else {
        // é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°çŠ¶æ€å˜ä¸º ESTABLISHED
        return tcp_wait_connect(sk);
    }
}
```

**å‘é€ SYN åŒ…çš„å‡½æ•°ï¼š**

**ä»£ç ä½ç½®ï¼š** [src/tcp_output.c](src/tcp_output.c)

```c
int tcp_send_synack(struct sock *sk)
{
    struct tcp_sock *tsk = tcp_sk(sk);
    struct sk_buff *skb;
    struct tcphdr *th;

    // 1. åˆ†é… skb
    skb = alloc_skb(TCP_HDR_LEN + 40);  // 40 å­—èŠ‚ç•™ç»™é€‰é¡¹

    // 2. æ„é€  TCP å¤´
    th = (struct tcphdr *)skb->data;
    th->sport = htons(sk->sport);
    th->dport = htons(sk->dport);
    th->seq = htonl(tsk->tcb.snd_nxt);
    th->ack_seq = 0;  // SYN åŒ…ä¸éœ€è¦ ACK
    th->syn = 1;      // è®¾ç½® SYN æ ‡å¿—
    th->ack = 0;
    th->win = htons(tsk->tcb.rcv_wnd);

    // 3. æ·»åŠ  MSS é€‰é¡¹
    // ...

    // 4. å‘é€
    tcp_transmit_skb(sk, skb);

    // 5. è®¾ç½®é‡ä¼ å®šæ—¶å™¨
    tcp_start_rto_timer(tsk);
}
```

#### æ­¥éª¤ 2: æ¥æ”¶ SYN+ACK

å½“è¿œç¨‹æœåŠ¡å™¨å‘é€ SYN+ACK å›æ¥æ—¶ï¼Œä¼šè¢« `THREAD_CORE` çº¿ç¨‹æ¥æ”¶ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°ï¼š

**ä»£ç ä½ç½®ï¼š** [src/tcp_input.c](src/tcp_input.c) ä¸­çš„ `tcp_synsent()`

```c
static int tcp_synsent(struct sock *sk, struct tcphdr *th, struct sk_buff *skb)
{
    struct tcp_sock *tsk = tcp_sk(sk);

    // 1. æ£€æŸ¥ ACK æ ‡å¿—
    if (th->ack) {
        // éªŒè¯ ACK å·æ˜¯å¦æ­£ç¡®
        if (th->ack_seq != tsk->tcb.snd_nxt) {
            tcp_send_reset(sk);  // ACK å·ä¸å¯¹ï¼Œå‘é€ RST
            return -1;
        }

        tsk->tcb.snd_una = th->ack_seq;  // æ›´æ–°æœªç¡®è®¤åºåˆ—å·
    }

    // 2. æ£€æŸ¥ SYN æ ‡å¿—
    if (th->syn) {
        tsk->tcb.irs = th->seq;          // ä¿å­˜åˆå§‹æ¥æ”¶åºåˆ—å·
        tsk->tcb.rcv_nxt = th->seq + 1;  // ä¸‹ä¸€ä¸ªæœŸæœ›çš„åºåˆ—å·

        // 3. è§£æ TCP é€‰é¡¹ï¼ˆMSSã€SACK ç­‰ï¼‰
        tcp_parse_opts(tsk, th);

        // 4. å¦‚æœæœ‰ ACKï¼Œè¯´æ˜æ˜¯ SYN+ACK
        if (th->ack) {
            tcp_set_state(sk, TCP_ESTABLISHED);  // è¿æ¥å»ºç«‹

            // 5. å‘é€ ACK
            tcp_send_ack(sk);

            // 6. åœæ­¢é‡ä¼ å®šæ—¶å™¨
            tcp_stop_rto_timer(tsk);

            // 7. å”¤é†’ç­‰å¾…çš„åº”ç”¨ç¨‹åº
            wait_wakeup(&sk->sock->sleep);
        }
    }

    return 0;
}
```

#### æ­¥éª¤ 3: å‘é€ ACK

**ä»£ç ä½ç½®ï¼š** [src/tcp_output.c](src/tcp_output.c)

```c
int tcp_send_ack(struct sock *sk)
{
    struct tcp_sock *tsk = tcp_sk(sk);
    struct sk_buff *skb;
    struct tcphdr *th;

    skb = alloc_skb(TCP_HDR_LEN);

    th = (struct tcphdr *)skb->data;
    th->sport = htons(sk->sport);
    th->dport = htons(sk->dport);
    th->seq = htonl(tsk->tcb.snd_nxt);
    th->ack_seq = htonl(tsk->tcb.rcv_nxt);  // ç¡®è®¤æ”¶åˆ° SYN
    th->syn = 0;
    th->ack = 1;  // è®¾ç½® ACK æ ‡å¿—
    th->win = htons(tsk->tcb.rcv_wnd);

    tcp_transmit_skb(sk, skb);
}
```

### 6.3 çŠ¶æ€è½¬æ¢å›¾

```
          åº”ç”¨ç¨‹åºè°ƒç”¨ connect()
                  â”‚
                  â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  CLOSED   â”‚
            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                  â”‚ å‘é€ SYN
                  â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ SYN_SENT  â”‚ â—„â”€â”
            â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚ è¶…æ—¶é‡ä¼  SYN
                  â”‚         â”‚
         æ”¶åˆ° SYN+ACK       â”‚
                  â”‚         â”‚
                  â–¼         â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
            â”‚ ESTABLISHED  â”‚â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                  â”‚          â”‚
            (å‘é€ ACK) â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. æ•°æ®ä¼ è¾“æµç¨‹

### 7.1 å‘é€æ•°æ®

#### åºåˆ—å·ç®¡ç†

**å…³é”®å˜é‡ï¼š**

```c
struct tcb {
    uint32_t snd_una;  // Send Unacknowledged - æœ€è€çš„æœªç¡®è®¤å­—èŠ‚
    uint32_t snd_nxt;  // Send Next - ä¸‹ä¸€ä¸ªè¦å‘é€çš„åºåˆ—å·
    uint32_t snd_wnd;  // Send Window - å¯¹æ–¹çš„æ¥æ”¶çª—å£å¤§å°
};
```

**å‘é€çª—å£ç¤ºæ„å›¾ï¼š**

```
å·²å‘é€å·²ç¡®è®¤    å·²å‘é€æœªç¡®è®¤      å¯å‘é€      ä¸å¯å‘é€
    â”‚              â”‚               â”‚           â”‚
    â–¼              â–¼               â–¼           â–¼
â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€>
  snd_una       snd_nxt      snd_una+snd_wnd

    â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
      å·²å‘é€ä½†æœª      å¯ä»¥å‘é€çš„
      æ”¶åˆ°ç¡®è®¤çš„      æ•°æ®èŒƒå›´
```

#### æ•°æ®åˆ†æ®µ

TCP éœ€è¦å°†å¤§å—æ•°æ®åˆ†æˆå¤šä¸ªæ®µï¼ˆSegmentï¼‰å‘é€ï¼Œæ¯ä¸ªæ®µä¸èƒ½è¶…è¿‡ **MSSï¼ˆæœ€å¤§æ®µå¤§å°ï¼‰**ã€‚

**ä»£ç ä½ç½®ï¼š** [src/tcp.c](src/tcp.c) ä¸­çš„ `tcp_write()`

```c
int tcp_write(struct sock *sk, const void *buf, int len)
{
    struct tcp_sock *tsk = tcp_sk(sk);
    int mss = tsk->smss;  // å‘é€ MSSï¼ˆå¯¹æ–¹å‘Šè¯‰æˆ‘ä»¬çš„ï¼‰

    // æ£€æŸ¥æ˜¯å¦æœ‰è¶³å¤Ÿçš„å‘é€çª—å£
    int available_window = tsk->tcb.snd_una + tsk->tcb.snd_wnd - tsk->tcb.snd_nxt;

    while (len > 0) {
        // è®¡ç®—æœ¬æ¬¡å‘é€çš„é•¿åº¦
        int slen = min(len, mss);
        slen = min(slen, available_window);

        if (slen <= 0) {
            break;  // çª—å£æ»¡äº†ï¼Œæš‚æ—¶ä¸èƒ½å‘é€
        }

        // åˆ›å»º skb
        struct sk_buff *skb = alloc_skb(TCP_HDR_LEN + slen);
        memcpy(skb->data + TCP_HDR_LEN, buf, slen);

        // è®¾ç½®åºåˆ—å·
        skb->seq = tsk->tcb.snd_nxt;
        skb->end_seq = skb->seq + slen;

        // åŠ å…¥å‘é€é˜Ÿåˆ—ï¼ˆç”¨äºé‡ä¼ ï¼‰
        skb_queue_tail(&sk->write_queue, skb);

        // æ›´æ–°å‘é€æŒ‡é’ˆ
        tsk->tcb.snd_nxt += slen;

        buf += slen;
        len -= slen;
        available_window -= slen;
    }

    // è§¦å‘å®é™…å‘é€
    tcp_output(sk);

    return len;  // è¿”å›æœªå‘é€çš„å­—èŠ‚æ•°
}
```

### 7.2 æ¥æ”¶æ•°æ®

#### æ¥æ”¶çª—å£ç®¡ç†

**å…³é”®å˜é‡ï¼š**

```c
struct tcb {
    uint32_t rcv_nxt;  // Receive Next - ä¸‹ä¸€ä¸ªæœŸæœ›æ¥æ”¶çš„åºåˆ—å·
    uint32_t rcv_wnd;  // Receive Window - æ¥æ”¶çª—å£å¤§å°
};
```

**æ¥æ”¶çª—å£ç¤ºæ„å›¾ï¼š**

```
å·²æ¥æ”¶å·²è¯»å–    å·²æ¥æ”¶æœªè¯»å–      å¯æ¥æ”¶      è¶…å‡ºçª—å£
    â”‚              â”‚               â”‚           â”‚
    â–¼              â–¼               â–¼           â–¼
â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€>
                rcv_nxt      rcv_nxt+rcv_wnd

                â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
                   æ¥æ”¶çª—å£èŒƒå›´
```

#### ä¹±åºå¤„ç†

å¦‚æœæ”¶åˆ°çš„æ•°æ®åŒ…ä¸æ˜¯æœŸæœ›çš„åºåˆ—å·ï¼Œéœ€è¦æ”¾å…¥ **ä¹±åºé˜Ÿåˆ—**ã€‚

**ä»£ç ä½ç½®ï¼š** [src/tcp_data.c](src/tcp_data.c)

```c
// ä¹±åºé˜Ÿåˆ—ç»“æ„
struct sk_buff_head ofo_queue;  // Out-of-Order Queue

// æ’å…¥ä¹±åºé˜Ÿåˆ—ï¼ˆæŒ‰åºåˆ—å·æ’åºï¼‰
int tcp_queue_ofo(struct sock *sk, struct sk_buff *skb)
{
    struct tcp_sock *tsk = tcp_sk(sk);
    struct sk_buff *skb1;

    // æŒ‰åºåˆ—å·ä»å°åˆ°å¤§æ’å…¥
    skb_queue_walk(&tsk->ofo_queue, skb1) {
        if (skb->seq < skb1->seq) {
            __skb_queue_before(&tsk->ofo_queue, skb1, skb);
            return 0;
        }
    }

    // æ’å…¥åˆ°é˜Ÿå°¾
    skb_queue_tail(&tsk->ofo_queue, skb);
    return 0;
}

// å¤„ç†ä¹±åºé˜Ÿåˆ—ï¼Œå°†å·²ç»è¿ç»­çš„æ•°æ®ç§»åˆ°æ¥æ”¶é˜Ÿåˆ—
void tcp_data_dequeue_ofo(struct tcp_sock *tsk)
{
    struct sk_buff *skb;

    while ((skb = skb_peek(&tsk->ofo_queue)) != NULL) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯æœŸæœ›çš„åºåˆ—å·
        if (skb->seq == tsk->tcb.rcv_nxt) {
            // ä»ä¹±åºé˜Ÿåˆ—ç§»é™¤
            skb_dequeue(&tsk->ofo_queue);

            // åŠ å…¥æ¥æ”¶é˜Ÿåˆ—
            skb_queue_tail(&tsk->sk.receive_queue, skb);

            // æ›´æ–°æœŸæœ›åºåˆ—å·
            tsk->tcb.rcv_nxt += skb->dlen;
        } else {
            break;  // è¿˜æœ‰ç©ºæ´ï¼Œç­‰å¾…åç»­æ•°æ®
        }
    }
}
```

**ä¹±åºå¤„ç†ç¤ºä¾‹ï¼š**

```
æœŸæœ›åºåˆ—å·: 1000

æ”¶åˆ°æ•°æ®åŒ…:
1. seq=1200, len=100  â†’ æ”¾å…¥ä¹±åºé˜Ÿåˆ—
2. seq=1100, len=100  â†’ æ”¾å…¥ä¹±åºé˜Ÿåˆ—ï¼ˆä¿æŒæ’åºï¼‰
3. seq=1000, len=100  â†’ ç›´æ¥æ”¾å…¥æ¥æ”¶é˜Ÿåˆ—ï¼Œæ›´æ–° rcv_nxt=1100
                        ç„¶åæ£€æŸ¥ä¹±åºé˜Ÿåˆ—ï¼Œå‘ç° 1100 å’Œ 1200 éƒ½å¯ä»¥ç§»åŠ¨
                        æœ€ç»ˆ rcv_nxt=1300

ä¹±åºé˜Ÿåˆ—å˜åŒ–:
[ç©º] â†’ [1200] â†’ [1100, 1200] â†’ [1100, 1200] â†’ [ç©º]
                                 â””â”€ç§»åˆ°æ¥æ”¶é˜Ÿåˆ—â”€â”˜
```

---

## 8. TCP é‡ä¼ æœºåˆ¶

### 8.1 é‡ä¼ å®šæ—¶å™¨ (RTO)

**RTO = Retransmission Timeout**ï¼Œå³è¶…è¿‡è¿™ä¸ªæ—¶é—´æ²¡æ”¶åˆ° ACK å°±é‡ä¼ ã€‚

**ä»£ç ä½ç½®ï¼š** [src/tcp.c](src/tcp.c) å’Œ [src/timer.c](src/timer.c)

#### RTO è®¡ç®—ï¼ˆRFC 6298ï¼‰

```c
// 1. æµ‹é‡ RTT (Round-Trip Time)
int rtt = current_time - packet_send_time;

// 2. æ›´æ–° SRTT (Smoothed RTT)
if (first_measurement) {
    srtt = rtt;
    rttvar = rtt / 2;
} else {
    rttvar = 0.75 * rttvar + 0.25 * abs(srtt - rtt);
    srtt = 0.875 * srtt + 0.125 * rtt;
}

// 3. è®¡ç®— RTO
rto = srtt + max(1, 4 * rttvar);
rto = max(rto, 200);  // æœ€å° 200ms
```

#### é‡ä¼ æµç¨‹

```
å‘é€æ•°æ®åŒ…
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€> å¯åŠ¨ RTO å®šæ—¶å™¨
    â”‚
    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚  ç­‰å¾… ACK     â”‚
    â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                â”‚
    â”‚         æ”¶åˆ° ACK? â”€â”€Yesâ”€â”€> åœæ­¢å®šæ—¶å™¨
    â”‚                â”‚
    â”‚               No
    â”‚                â”‚
    â”‚         RTO è¶…æ—¶
    â”‚                â”‚
    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚  é‡ä¼ æ•°æ®åŒ…   â”‚
    â”‚         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                â”‚
    â”‚         backoff *= 2  (æŒ‡æ•°é€€é¿)
    â”‚         rto *= 2
    â”‚                â”‚
    â”‚         é‡ä¼ æ¬¡æ•° < 3? â”€â”€Yesâ”€â”€> é‡æ–°å¯åŠ¨å®šæ—¶å™¨
    â”‚                â”‚
    â”‚               No
    â”‚                â”‚
    â”‚         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         â”‚  å…³é—­è¿æ¥     â”‚
    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä»£ç ä½ç½®ï¼š** [src/tcp_output.c](src/tcp_output.c)

```c
void tcp_rto(struct timer *t)
{
    struct sock *sk = (struct sock *)t->arg;
    struct tcp_sock *tsk = tcp_sk(sk);

    // 1. æ£€æŸ¥é‡ä¼ æ¬¡æ•°
    if (tsk->backoff >= TCP_CONN_RETRIES) {
        // è¶…è¿‡æœ€å¤§é‡ä¼ æ¬¡æ•°ï¼Œå…³é—­è¿æ¥
        tcp_done(sk);
        return;
    }

    // 2. æŒ‡æ•°é€€é¿
    tsk->backoff++;
    tsk->rto *= 2;

    // 3. é‡ä¼ å‘é€é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªåŒ…
    struct sk_buff *skb = skb_peek(&sk->write_queue);
    if (skb) {
        tcp_transmit_skb(sk, skb_clone(skb));
    }

    // 4. é‡æ–°å¯åŠ¨å®šæ—¶å™¨
    tcp_start_rto_timer(tsk);
}
```

---

## 9. IPC é€šä¿¡æœºåˆ¶

### 9.1 ä¸ºä»€ä¹ˆéœ€è¦ IPCï¼Ÿ

åº”ç”¨ç¨‹åºè¿è¡Œåœ¨è‡ªå·±çš„è¿›ç¨‹ä¸­ï¼Œlvl-ip å®ˆæŠ¤è¿›ç¨‹æ˜¯å¦ä¸€ä¸ªè¿›ç¨‹ã€‚å®ƒä»¬éœ€è¦é€šä¿¡æœºåˆ¶æ¥ä¼ é€’ socket æ“ä½œã€‚

### 9.2 Unix Domain Socket

**ä»£ç ä½ç½®ï¼š** [tools/liblevelip.c](tools/liblevelip.c)

#### è¿æ¥å»ºç«‹

```c
static int init_socket(char *sockname)
{
    struct sockaddr_un addr;
    int data_socket;

    // 1. åˆ›å»º Unix Socket
    data_socket = _socket(AF_UNIX, SOCK_STREAM, 0);

    // 2. è®¾ç½®åœ°å€
    memset(&addr, 0, sizeof(struct sockaddr_un));
    addr.sun_family = AF_UNIX;
    strncpy(addr.sun_path, sockname, sizeof(addr.sun_path) - 1);

    // 3. è¿æ¥åˆ° lvl-ip å®ˆæŠ¤è¿›ç¨‹
    ret = _connect(data_socket, (const struct sockaddr *) &addr,
                   sizeof(struct sockaddr_un));

    return data_socket;
}
```

**Unix Socket è·¯å¾„ï¼š** `/var/run/lvl-ip-<PID>.sock`

### 9.3 æ¶ˆæ¯æ ¼å¼

**ä»£ç ä½ç½®ï¼š** [include/ipc.h](include/ipc.h)

```c
struct ipc_msg {
    uint16_t type;      // æ¶ˆæ¯ç±»å‹ (SOCKET, CONNECT, WRITE, READ...)
    pid_t pid;          // è¿›ç¨‹ ID
    uint8_t data[];     // æ¶ˆæ¯æ•°æ®
};

// ä¸åŒç±»å‹çš„æ¶ˆæ¯æ•°æ®
struct ipc_socket {
    int domain;
    int type;
    int protocol;
};

struct ipc_connect {
    int sockfd;
    struct sockaddr addr;
    socklen_t addrlen;
};

struct ipc_write {
    int sockfd;
    size_t len;
    uint8_t buf[];
};

struct ipc_read {
    int sockfd;
    size_t len;
};
```

### 9.4 é€šä¿¡æ—¶åºå›¾

```
åº”ç”¨ç¨‹åº           liblevelip.so        lvl-ip (THREAD_IPC)      åè®®æ ˆ
   â”‚                    â”‚                        â”‚                   â”‚
   â”‚ write(fd, buf, 100)â”‚                        â”‚                   â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                        â”‚                   â”‚
   â”‚                    â”‚                        â”‚                   â”‚
   â”‚                    â”‚ 1. æ„é€  IPC_WRITE æ¶ˆæ¯  â”‚                   â”‚
   â”‚                    â”‚    [type=WRITE|pid|    â”‚                   â”‚
   â”‚                    â”‚     fd|len=100|data]   â”‚                   â”‚
   â”‚                    â”‚                        â”‚                   â”‚
   â”‚                    â”‚ 2. å‘é€åˆ° Unix Socket   â”‚                   â”‚
   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                   â”‚
   â”‚                    â”‚                        â”‚                   â”‚
   â”‚                    â”‚                        â”‚ 3. ipc_write()    â”‚
   â”‚                    â”‚                        â”‚   è§£ææ¶ˆæ¯        â”‚
   â”‚                    â”‚                        â”‚                   â”‚
   â”‚                    â”‚                        â”‚ 4. æŸ¥æ‰¾ socket    â”‚
   â”‚                    â”‚                        â”‚   get_socket(pid,fd)
   â”‚                    â”‚                        â”‚                   â”‚
   â”‚                    â”‚                        â”‚ 5. è°ƒç”¨ write     â”‚
   â”‚                    â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                    â”‚                        â”‚                   â”‚
   â”‚                    â”‚                        â”‚                   â”‚ tcp_write()
   â”‚                    â”‚                        â”‚                   â”‚ å¤„ç†æ•°æ®
   â”‚                    â”‚                        â”‚                   â”‚
   â”‚                    â”‚                        â”‚ 6. è¿”å›ç»“æœ       â”‚
   â”‚                    â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                    â”‚                        â”‚                   â”‚
   â”‚                    â”‚ 7. å‘é€ IPC_ERR æ¶ˆæ¯    â”‚                   â”‚
   â”‚                    â”‚    [rc=100|err=0]      â”‚                   â”‚
   â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
   â”‚                    â”‚                        â”‚                   â”‚
   â”‚ 8. è¿”å› 100         â”‚                        â”‚                   â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚                   â”‚
```

---

## 10. å…³é”®ä»£ç è·¯å¾„æ€»ç»“

### 10.1 å¯åŠ¨æµç¨‹

**ä»£ç ä½ç½®ï¼š** [src/main.c:123-135](src/main.c#L123-L135)

```
main()
  â”œâ”€> parse_cli()          è§£æå‘½ä»¤è¡Œå‚æ•°
  â”œâ”€> init_signals()       åˆå§‹åŒ–ä¿¡å·å¤„ç†
  â”œâ”€> init_stack()         åˆå§‹åŒ–åè®®æ ˆ
  â”‚     â”œâ”€> tun_init()           åˆå§‹åŒ– TAP è®¾å¤‡
  â”‚     â”œâ”€> netdev_init()        åˆå§‹åŒ–ç½‘ç»œè®¾å¤‡
  â”‚     â”œâ”€> route_init()         åˆå§‹åŒ–è·¯ç”±è¡¨
  â”‚     â”œâ”€> arp_init()           åˆå§‹åŒ– ARP ç¼“å­˜
  â”‚     â””â”€> tcp_init()           åˆå§‹åŒ– TCP
  â”œâ”€> init_security()      é™ä½æƒé™
  â”œâ”€> run_threads()        å¯åŠ¨å››ä¸ªçº¿ç¨‹
  â”‚     â”œâ”€> THREAD_CORE      netdev_rx_loop()
  â”‚     â”œâ”€> THREAD_TIMERS    timers_start()
  â”‚     â”œâ”€> THREAD_IPC       start_ipc_listener()
  â”‚     â””â”€> THREAD_SIGNAL    stop_stack_handler()
  â”œâ”€> wait_for_threads()   ç­‰å¾…çº¿ç¨‹ç»“æŸ
  â””â”€> free_stack()         æ¸…ç†èµ„æº
```

### 10.2 æ•°æ®åŒ…æ¥æ”¶è·¯å¾„

```
TAP è®¾å¤‡
  â”‚
  â–¼ tun_read()
netdev_rx_loop()
  â”‚
  â–¼ netdev_receive()
ã€ä»¥å¤ªç½‘å±‚ã€‘
  â”‚
  â”œâ”€> EtherType=0x0806 â†’ arp_rcv()
  â”‚                         â””â”€> arp_request/arp_reply
  â”‚
  â””â”€> EtherType=0x0800 â†’ ip_rcv()
                           â”‚
                           â–¼ ã€IPå±‚ã€‘
                         tcp_in()
                           â”‚
                           â–¼ ã€TCPå±‚ã€‘
                         tcp_input_state()
                           â”‚
                           â”œâ”€> TCP_LISTEN
                           â”œâ”€> TCP_SYN_SENT â†’ tcp_synsent()
                           â”œâ”€> TCP_SYN_RECEIVED
                           â”œâ”€> TCP_ESTABLISHED â†’ tcp_established()
                           â”œâ”€> TCP_FIN_WAIT_1
                           â”œâ”€> TCP_FIN_WAIT_2
                           â”œâ”€> TCP_CLOSE_WAIT
                           â””â”€> ...
```

### 10.3 æ•°æ®åŒ…å‘é€è·¯å¾„

```
åº”ç”¨ç¨‹åº write()
  â”‚
  â–¼ liblevelip.so æ‹¦æˆª
IPC æ¶ˆæ¯
  â”‚
  â–¼ ipc_write()
socket_write()
  â”‚
  â–¼ sock->ops->write()
tcp_write()
  â”‚
  â”œâ”€> æ•°æ®åˆ†æ®µ
  â”œâ”€> åŠ å…¥å‘é€é˜Ÿåˆ—
  â””â”€> tcp_output()
        â”‚
        â–¼ tcp_send()
      tcp_transmit_skb()
        â”‚
        â”œâ”€> æ„é€  TCP å¤´
        â”œâ”€> è®¡ç®—æ ¡éªŒå’Œ
        â””â”€> ip_output()
              â”‚
              â”œâ”€> æ„é€  IP å¤´
              â”œâ”€> æŸ¥æ‰¾è·¯ç”±
              â””â”€> dst_neigh_output()
                    â”‚
                    â”œâ”€> arp_get_hwaddr() è·å– MAC åœ°å€
                    â””â”€> netdev_transmit()
                          â”‚
                          â”œâ”€> æ„é€ ä»¥å¤ªç½‘å¤´
                          â””â”€> tun_write()
                                â”‚
                                â–¼ TAP è®¾å¤‡
```

---

## 11. è°ƒè¯•æŠ€å·§

### 11.1 å¯ç”¨è°ƒè¯•è¾“å‡º

```bash
# ç¼–è¯‘æ—¶å¯ç”¨æ‰€æœ‰è°ƒè¯•
make clean
CFLAGS="-DDEBUG_TCP -DDEBUG_SOCKET" make debug

# è¿è¡Œ
./lvl-ip
```

### 11.2 ä½¿ç”¨ tcpdump æŠ“åŒ…

```bash
# ç›‘å¬ TAP è®¾å¤‡
sudo tcpdump -i tap0 -n -vvv

# åªçœ‹ TCP
sudo tcpdump -i tap0 tcp -n

# ä¿å­˜åˆ°æ–‡ä»¶
sudo tcpdump -i tap0 -w capture.pcap
```

### 11.3 ä½¿ç”¨ GDB è°ƒè¯•

```bash
# å¯åŠ¨ GDB
gdb ./lvl-ip

# è®¾ç½®æ–­ç‚¹
(gdb) break tcp_in
(gdb) break tcp_output

# è¿è¡Œ
(gdb) run

# æŸ¥çœ‹çº¿ç¨‹
(gdb) info threads

# åˆ‡æ¢çº¿ç¨‹
(gdb) thread 2
```

### 11.4 æŸ¥çœ‹å†…éƒ¨çŠ¶æ€

åœ¨ä»£ç ä¸­å·²ç»æœ‰å¾ˆå¤šè°ƒè¯•å®ï¼Œä¾‹å¦‚ï¼š

```c
// TCP çŠ¶æ€
tcpsock_dbg("message", sk);

// Socket çŠ¶æ€
socket_dbg(sock, "message");

// TCP è¾“å…¥
tcp_in_dbg(th, sk, skb);

// TCP è¾“å‡º
tcp_out_dbg(th, sk, skb);
```

---

## 12. å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦ TAP è®¾å¤‡ï¼Ÿ

**ç­”ï¼š** TAP è®¾å¤‡æ˜¯ä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œå®ƒå¯ä»¥ï¼š
1. è®©ç”¨æˆ·ç¨‹åºç›´æ¥è¯»å†™ä»¥å¤ªç½‘å¸§
2. ä¸éœ€è¦ä¿®æ”¹å†…æ ¸ä»£ç 
3. å¯ä»¥å’ŒçœŸå®ç½‘ç»œäº¤äº’ï¼ˆé€šè¿‡ NATï¼‰

### Q2: åºåˆ—å·æ˜¯å¦‚ä½•ç”Ÿæˆçš„ï¼Ÿ

**ç­”ï¼š** åˆå§‹åºåˆ—å· (ISS) éœ€è¦éšæœºç”Ÿæˆï¼Œé¿å…è¢«é¢„æµ‹ã€‚Level-IP ä½¿ç”¨ï¼š

```c
int generate_iss()
{
    // ä½¿ç”¨å½“å‰æ—¶é—´ + éšæœºæ•°
    return (timer_get_tick() * 1000) + (rand() % 1000);
}
```

### Q3: å¦‚ä½•å¤„ç†å¹¶å‘ï¼Ÿ

**ç­”ï¼š** Level-IP ä½¿ç”¨å¤šç§é”æœºåˆ¶ï¼š
- **pthread_rwlock_t**ï¼šè¯»å†™é”ï¼Œä¿æŠ¤ socket åˆ—è¡¨
- **pthread_mutex_t**ï¼šäº’æ–¥é”ï¼Œä¿æŠ¤ ARP ç¼“å­˜
- **wait_lock**ï¼šç­‰å¾…é˜Ÿåˆ—é”ï¼Œç”¨äºé˜»å¡æ“ä½œ

### Q4: é‡ä¼ é˜Ÿåˆ—ä»€ä¹ˆæ—¶å€™æ¸…ç†ï¼Ÿ

**ç­”ï¼š** å½“æ”¶åˆ° ACK æ—¶ï¼š

```c
static int tcp_clean_rto_queue(struct sock *sk, uint32_t una)
{
    while ((skb = skb_peek(&sk->write_queue)) != NULL) {
        if (skb->end_seq <= una) {
            // è¿™ä¸ªåŒ…å·²ç»è¢«ç¡®è®¤äº†
            skb_dequeue(&sk->write_queue);
            free_skb(skb);
        } else {
            break;  // åé¢çš„åŒ…è¿˜æ²¡ç¡®è®¤
        }
    }
}
```

---

## 13. æ‰©å±•é˜…è¯»

### 13.1 ç›¸å…³ RFC æ–‡æ¡£

- **RFC 793**: TCP åè®®è§„èŒƒ
- **RFC 6298**: TCP é‡ä¼ å®šæ—¶å™¨è®¡ç®—
- **RFC 2018**: TCP é€‰æ‹©æ€§ç¡®è®¤ (SACK)
- **RFC 5681**: TCP æ‹¥å¡æ§åˆ¶
- **RFC 826**: ARP åè®®

### 13.2 æ¨èèµ„æº

- Linux å†…æ ¸ TCP/IP æºç 
- ã€ŠTCP/IP è¯¦è§£ å·1ã€‹
- ã€ŠLinux å†…æ ¸æºç å‰–æï¼šTCP/IP å®ç°ã€‹

---

## é™„å½•ï¼šæœ¯è¯­è¡¨

| æœ¯è¯­ | å…¨ç§° | è¯´æ˜ |
|------|------|------|
| TAP | TUN/TAP Device | è™šæ‹Ÿç½‘å¡è®¾å¤‡ |
| sk_buff | Socket Buffer | æ•°æ®åŒ…ç¼“å†²åŒºç»“æ„ |
| MSS | Maximum Segment Size | æœ€å¤§æ®µå¤§å° |
| MTU | Maximum Transmission Unit | æœ€å¤§ä¼ è¾“å•å…ƒ |
| RTT | Round-Trip Time | å¾€è¿”æ—¶é—´ |
| RTO | Retransmission Timeout | é‡ä¼ è¶…æ—¶æ—¶é—´ |
| ISS | Initial Send Sequence | åˆå§‹å‘é€åºåˆ—å· |
| IRS | Initial Receive Sequence | åˆå§‹æ¥æ”¶åºåˆ—å· |
| IPC | Inter-Process Communication | è¿›ç¨‹é—´é€šä¿¡ |
| ARP | Address Resolution Protocol | åœ°å€è§£æåè®® |
| SACK | Selective Acknowledgment | é€‰æ‹©æ€§ç¡®è®¤ |

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0
**æœ€åæ›´æ–°ï¼š** 2026-01-17
**ä½œè€…ï¼š** Level-IP é¡¹ç›®ç»„
